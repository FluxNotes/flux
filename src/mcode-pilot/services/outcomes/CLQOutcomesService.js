import request from "request";
import IOutcomesService from './IOutcomesService';
import _ from 'lodash';

export default class CLQOutcomesService extends IOutcomesService {
    constructor(params) {
        super();
        this.serviceUrl = params.serviceUrl;
        this.timescale = params.timescale || [];
        this.apiKey = params.apiKey;
        this.filters = params.filters;
    }

    /* Build the CLQ demograpchics filter section based off of the Compass filter criteria
     */
    buildDemographicsFilter(activeFilterValues) {
        const filter = {};
        const gender = activeFilterValues["shr.core.BirthSex"];
        const race = activeFilterValues["shr.core.Race"];
        const age = activeFilterValues["shr.core.DateOfBirth"];
        const age_at_diagnosis = activeFilterValues["shr.core.DateOfDiagnosis"];
        if (gender) {
            filter.gender = {
                codeSystemName: "AdministrativeGender",
                codeSystem: "2.16.840.1.113883.4.642.2.1",
                code: gender.value
            };
        }
        if (age) {
            filter.age = {
                min: age.minValue,
                max: age.maxValue
            };
        }
        if (age_at_diagnosis) {
            filter.age_at_diagnosis = {
                min: age_at_diagnosis.minValue,
                max: age_at_diagnosis.maxValue
            };
        }
        if (race) {
            filter.race = {
                "codeSystemName": "HL7 v3 Code System Race",
                "codeSystem": "2.16.840.1.113883.5.104",
                "code": race.value
            };
        }
        return filter;
    }

    /* Build the CLQ diagnosis filter based off of the Comapss Filter options
     */
    buildDiagnosisFilter(activeFilterValues) {
        const filter = {};
        const stage = activeFilterValues["onco.core.TNMClinicalStageGroup"];
        const t = activeFilterValues["onco.core.TNMClinicalPrimaryTumorCategory"];
        const n = activeFilterValues["onco.core.TNMClinicalRegionalNodesCategory"];
        const m = activeFilterValues["onco.core.TNMClinicalDistantMetastasesCategory"];
        const grade = activeFilterValues["onco.core.CancerHistologicGrade"];
        if (stage) {
            filter.stage = stage.reference.stage;
        }
        if (grade) {
            filter.grade = grade.reference.getGradeAsSimpleNumber();
        }
        filter.tnm = {};
        if (t) {
            filter.tnm.t = t.value;
        }
        if (n) {
            filter.tnm.n = n.value;
        }
        if (m) {
            filter.tnm.m = m.value;
        }
        return filter;
    }

    /* Build the CLQ tumor markers filter sections based off the tumor makrkers found in the similar
    patient properties
    */
    buildTumorMarkersFilter(activeFilterValues) {
        const filter = [];
        // loop over options look for tumor markers and add to filter
        let markers = activeFilterValues["onco.core.TumorMarkerTest"];
        if (!_.isEmpty(markers) && !Array.isArray(markers)) {
            markers = [markers];
        }
        for (const x in markers) {
            const option = markers[x];
            const code = option.reference.receptorTypeCodeableConcept;
            const value = option.value;
            filter.push({
                code: code.codeValue.code,
                codeSystem: code.codeSystem.uri,
                displayName: code.displayText.string,
                value: _.startCase(_.toLower(value))
            });
        }
        return filter;
    }

    /* Process a filter generated by Compass.  This method will map the Compass filter items
    into a filter that is expected by the CLQ service and then call the service and process the
    response into a format that is used by the Compass UI */
    processSimilarPatientOutcomes(fOptions) {
        const filter = {};
        const activeFilterValues = fOptions.getAllActiveValuesByMcodeElement();
        filter.demographics = this.buildDemographicsFilter(activeFilterValues);
        filter.diagnosis = this.buildDiagnosisFilter(activeFilterValues);
        filter.tumorMarkers = this.buildTumorMarkersFilter(activeFilterValues);
        filter.outcomes = {
            survival: this.timescale.map((ts) => { return { "value": ts * 12, "interval": "months" }; })
        };
        return new Promise((accept, reject) => {
            request({
                url: this.serviceUrl,
                method: "POST",
                headers: {'Authorization': this.apiKey},
                json: filter
            }, (err, _response, data) => {
                if (err) {
                    reject(err);
                }
                try {
                    data.timescale = this.timescale;
                    accept(data);
                } catch (ex) {
                    reject(ex);
                }
            });

        });
    }
}
